## Tech Night @ Shiodome # 6 (テスト駆動開発)

## 組織にテストを書く文化を根付かせる戦略と戦術 - 和田卓人

- 周りに影響を及ぼしていくための作戦
- 流しのペアプロ業
    - WEB+DB PRESS
- power-assert
### 戦力編
- 疲弊しきった現場
- 荒みきったコード
    - コードの改修をせずにどんどん処理を追加している状態
- 爆弾処理のようなリリース
- テストがないコードはレガシーコードだ
    - レガシーコード改善ガイドより引用
    - 言語の年代は関係ない
- 2つの習わし
    - テストを書く時間はない　因果ループ
        - テストを書くことが良いことはわかっているのだが...
        - ストレスが増えるとテストが少なくなる
        - テストが減るとストレスが増える
        - 解決策
            - テストを先に書く。自動テストを行う
            - 自動テストが増えるとストレスが減る
            - ストレスが少ないと自動テストが増える
        - テスト書く時間がないのではなく、テストを書かないから時間がなくなる
    - 動くコードに触れるな
        - 直接改修せずにコピペが増える
        - 動くコードに手を入れられる構造を作る必要がある
        - コードは緩やかに死んで行く
- 文化を変えて行く
    - 文化の醸成は年単位の事業になる
- なんらかの形で評価をして行く必要がある
    - 品質を評価していくシステム
- ここから始める
    - 隣の芝は青い。気にしない。成長していけるスピードは個々に違う
    - 他人を動かすワード「周りはみんなやっている」
        - 劇薬
- 人を知る
    - コードが綺麗になって行く快感
    - 2回目以降は自動というお得感
    - そしてビジネスの価値観
        - 人によって何が良いかを考える

## 理論武装する
- 不具合の発見が遅れれば遅れるほどコストがかかる
    - 早めに気付ければコストはかからない
    - リリース時に発覚した時のコストと自動テスト時点で発覚した時のたらればを話す
- TDDの導入効果
    - MSやIBMの効果を例に（2008年）
    - 不具合は4割から9割減っている
    - 実装は2割から3割増えている
- 被験者のアンケート
    - 96% デバッグの工数を減らせると感じた
        - デバッグとは曲者　どれくらい時間がかかるか読めないプロセス
    - 88% 要求が洗練されると感じた
    - 92% コードの品質を上げられると感じた
    - 50% 開発工数を減らせると感じた
        - デバッグの工数が圧倒的に減ったため、開発工数が減ったと感じる
- 変えることの難しさ
    - 前例がない事例がない
    - 事前に許可を得るより、後で許してもらう方が楽
        - 自分一人か仲間を引き連れて成果を出した後に許可をもらう
- テストは品質を上げない
    - 品質がわかるようになる
    - テストを書くだけでは良くならない
        - 体重計に乗るだけでは痩せない
    - 品質を上げるのは設計とプログラミング
    - 再設計とリファクタリングをテストで支える
        - テストでは品質は上がらない。テストはあくまでも品質を上げるきっかけ

## 戦術編

- 2つの道しるべ
    - レガシーコード改善ガイド
        - レガシーコードに触るための語彙と技法を整理した本
        - テストを整備するまでにどういうことをするべきかが書かれている
        - レガシーコードのジレンマ
            - コードを変更するためにはテストを整備する必要がある。多くの場合はテストを整備するためにはコードを変更する必要がある
    - レガシーソフトウェア改善ガイド
        - ソフトウェアのリエンジニアリングを行う3つの選択肢を示している
            - リファクタリング
                - 限界が出てくる場合がある
            - リアーキテクティング
                - サブシステム単位でリライトしていく
            - ビッグ・リライト
                - 1から全て書き直す。新しい言語新しいアーキテクチャで

## どこにテストを書いていくか

- 何が一番やばいか
    - 最も困っているところ
        - お金、個人情報
    - 新機能開発から
    - バグ修正のところから
    - 静的解析でピンポイントに
- 傷んだ箇所と手が届く果実
- テストのトリアージ
    - リーン開発の現場
        - リスク
            - リスクが高いところを
        - 手動テストのコスト
            - コストがかかるところを
        - 自動テストのコスト
            - コードを書く難易度など
            - コストが低いところ
        - リスクが高く自動化コストがかからないところが一番費用対効果が良い
    - テストケースを一覧にまとめる

## どうやってテストを書いていくか

- レガシーコード改善ガイドに載ってある
- こだわるな
    - 最初から全部自動化しない
    - テスト駆動にこだわらない
    - テストファーストにこだわらない
    - ユニットテストにこだわらない
    - テストの実行速度にこだわらない
        - モックも良いができればリアルな環境でできるテストが良い
        - 実行速度が遅くても良いので信頼性のあるテストを
    - テストの網羅性にこだわらない
        - まずは正常系のケース1つとか
- こだわろう
    - 良いユニットテストの指標にも優先度がある
        - 再現、繰り返し可能
            - DBの中身で変わらないこと
        - テストは独立していること
            - テストの順番で結果が変わってしまってはいけない
        - 他はそれからでよい
- 設計の可動域を確保する
    - テストがないのはすでに設計が悪い兆候
    - 設計・実装を変えるのが前提
    - 実装のテストを書かないこと
        - 実装を変えるとテストも帰る必要がある場合はNG
- テスト自動化ピラミッドとアンチパターン
    - 自動ユニットテストが多く、手動テストが少ないのが良い
    - 自動ユニットテストが少なく、手動テストが多いのはアンチパターン
        - 最終的にはピラミッドにしていく
- TestSizes at Google
    - テストの大きさを大中小で分ける
    - テストの範囲に迷わない
- テストコードもメンテナンス対象のため重複は避けていく
- 誰とやるのか
    - ペアプロで鍛えていく
- アンチパターン
    - カバレッジを筆記試験のように扱う
    - カバレッジはあくまで書かれているコードに対してのもなので、書かれていないコードに対しては無意味
        - バグは書かれていないコードに対して発生するのが多い
    - カバレッジは計器の一つ
- 静的解析を使いこなす
- コードレビューのインフラに投資
    - GitHub GitLab
    - コードを見る文化、見られる文化を育てる
        - 見られるということで抑止力が生まれる
            - 少しでも綺麗なコードを書こうと思う
- 背中を見せる
    - サンプルとデモが大事
    - 真似してもらう土台を作る
    - テストのある生活を体験してもらう
    - 次にテストメンテナンスを学ぶ
- 量を書いていくうちに上手になっていく
    - テストコードを書こうと言っていても経験がないのであれば説得力がない

## ヤフオク! アプリの実践XP - ヤフー株式会社 山下真一郎

### 課題

- ビルド時間の増加
    - 新機能がどんどん追加されているため
- 不十分な単体テスト
    - リードタイムの増加

### Pivotal Labs

- LEAN XP
    - LEAN 何を作るか
    - XP どうやって作るか

### XP

- 効果のない技術的社会的な習慣を捨てる
    - ソーシャルチェンジ
- 価値
    - コミュニケーション
    - シンプル
    - 勇気

### プラクティス紹介

- ストーリー
    - 以前はFEとBEでインタフェースを擦り合わせて並行開発
        - 機能の一部分をFEからBEまで開発
- ペアプログラミング
    - 各ペアに細かいタスクで実装させる
        - 毎回ペアを変える。必ず片方1人は残るようにローテする
    - リファクタリングの過程が見れる
        - 自分の知らない実装が見れる
        - 技術力の底上げ
    - ストーリポイント
- TDD
    - ナビゲータがテストを作成
        - 失敗するテストを作成
    - ドライバーが実装
        - とりあえすテストが通る実装をする
    - ナビゲータがリファクタリング
        - リファクタリングを行い、結果が変わらないことを確認する

### 導入効果

- 受入テストの失敗率
    - 元は10%前後　1000ケース
    - LEAN XPでは11ケース失敗 8000ケース
- 残業時間
    - 管理職の人が残業している状態
        - 管理職もペアプロしているため、ペアプロ後に作業をする
    - 自立学習の促進



